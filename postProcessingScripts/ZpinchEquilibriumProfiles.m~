%%%%%%%%%%%%%%%%%%%%
%%%
%%%    d(P+B^2/2)/dr + B^2/r  = 0
%%%    or 
%%%    d(rP)/r - P/r + d(rB)/dr/r*B = 0;
%%%
%%%    d(r*(P+B^2/2))/dr - (P-B^2/2) = 0
%%%
%%%%%%%%%%%%%%%%%%%%
clear all;

nr = 1000;
R  = 1;
a  = R/3;
dr = R/nr;

rcc = -dr/2:dr:R+dr/2;
rce = rcc(1:end-1)+dr/2;
%rcc = abs(rcc);

x = rcc/a;
P = 1./(1+x.^2).^2;
B = sqrt(2)*x./(1+x.^2);
P(end) = P(end-1);
B(end) = B(end-1)*rcc(end-1)/rcc(end);
%P(end) = 2*P(end-1) - P(end-2);
%B(end) = 2*B(end-1) - B(end-2);
%P(end) = 3*(P(end-1) - P(end-2)) + P(end-3);
%B(end) = 3*(B(end-1) - B(end-2)) + B(end-3);

dPdr = -4*x./(1+x.^2).^3/a;
dB2over2dr = (-4*x.^3./(1+x.^2).^3+2*x./(1+x.^2).^2)/a;

figure(1); plot(rcc,P,'b');
hold on; plot(rcc,B,'r');


%%%   calculate numerical force balance using C2
%
f = P;
g = rcc.*(P+B.^2/2);
divFlux = zeros(size(rcc));
h = rcc.*B;
Jcc =  zeros(size(rcc));
Pcc =  zeros(size(rcc));
Bcc =  zeros(size(rcc));

for i=2:length(rcc)-1
    divFlux(i) = (g(i+1)-g(i-1))/2/rcc(i)/dr;
    Jcc(i)  = (h(i+1)-h(i-1))/2/dr/rcc(i);  
    Pcc(i)  = (P(i+1)+P(i-1))/2.0;
    Bcc(i)  = (B(i+1)+B(i-1))/2.0;
end
Pcc(1) = Pcc(2);
Pcc(end) = Pcc(end-1);
Pcc(end) = 2*Pcc(end-1)-Pcc(end-2);

Fr0 = -divFlux + (P-B.^2/2)./rcc;
Fr0(end-1) = Fr0(end-2)/3;
Fr0(1) = 0;
Fr0(end) = 0;

figure(3); hold on; plot(rcc,Fr0); box on; grid on;
title('radial force');


%%%   recalculate force using B defined from force balance
%
Btest = sqrt(2*(P - rcc.*divFlux));
Btest(1) = -Btest(2);
Btest(end) = Btest(end-1)*rcc(end-1)/rcc(end);

Fr1 = 0*Fr0;
g = rcc.*(P+Btest.^2/2);
divFlux1 = zeros(size(rcc));

for i=2:length(rcc)-1
    divFlux1(i) = (g(i+1)-g(i-1))/2/rcc(i)/dr;
end

Fr1 = -divFlux1 + (P-Btest.^2/2)./rcc;
Fr1(end-1) = Fr0(end-2)/3;
Fr1(1) = 0;
Fr1(end) = 0;

figure(3); hold on; plot(rcc,Fr1,'r--');



%%%   calculate pressure such that force balance is exact
%
Pcc2 = zeros(size(rcc));
Pcc2(1:2) = Pcc(1:2);

for i=2:length(rcc)-1
    Pcc2(i+1) = Pcc2(i-1) - 2*dr*Jcc(i)*B(i);
end
Pcc2(end) = Pcc2(end-1);
    
figure(1); hold on; plot(rcc,Pcc2,'r'); grid on;


%%%   calculate pressure gradient
%
dPcc2dr = zeros(size(rcc));
for i=2:length(rcc)-1
    dPcc2dr(i) = (Pcc2(i+1) - Pcc2(i-1))/2/dr;
end

Fr2 = - dPcc2dr - Jcc.*B;
Fr2(end-1) = Fr2(end-2)/3;
% Fr2(1) = 0;
% Fr2(end) = 0;
